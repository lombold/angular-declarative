name: Publish libraries

on:
  workflow_dispatch:
    inputs:
      publish_to:
        description: 'Registry to publish to (npm). Default: npm'
        required: false
        default: 'npm'

permissions:
  contents: write
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build libraries (nx)
        run: |
          npx nx run-many --target=build --projects=libs/form-engine,libs/page-engine,libs/process-engine,libs/declarative --parallel=false

      - name: Prepare npm authentication
        if: ${{ github.event.inputs.publish_to == 'npm' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # If NPM_TOKEN is not provided, skip preparing npmrc (avoids exposing secrets in workflow expressions)
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "NPM_TOKEN not set; skipping npm auth preparation"
            exit 0
          fi
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

      - name: Publish libraries to npm
        if: ${{ github.event.inputs.publish_to == 'npm' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # If NPM_TOKEN is not provided, skip publishing
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "NPM_TOKEN not set; skipping publish step"
            exit 0
          fi
          set -euo pipefail
          pkgs=(form-engine page-engine process-engine declarative)
          for pkg in "${pkgs[@]}"; do
            pkg_dir="dist/libs/$pkg"
            if [ -f "$pkg_dir/package.json" ]; then
              name=$(node -pe "require('./$pkg_dir/package.json').name")
              version=$(node -pe "require('./$pkg_dir/package.json').version")
              echo "Publishing $name@$version from $pkg_dir"
              (cd "$pkg_dir" && npm publish --access public)
            else
              echo "Warning: $pkg_dir/package.json not found — skipping publish for $pkg"
            fi
          done

      - name: Create and push git tags for published versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          pkgs=(form-engine page-engine process-engine declarative)
          for pkg in "${pkgs[@]}"; do
            pkg_dir="dist/libs/$pkg"
            if [ -f "$pkg_dir/package.json" ]; then
              name=$(node -pe "require('./$pkg_dir/package.json').name")
              version=$(node -pe "require('./$pkg_dir/package.json').version")
              # sanitize package name for tag: remove leading @ and replace / with -
              sanitized=$(echo "$name" | sed 's|@||; s|/|-|g')
              tag="${sanitized}@${version}"

              if git rev-parse "refs/tags/$tag" >/dev/null 2>&1; then
                echo "Tag $tag already exists — skipping"
              else
                git tag "$tag"
                git push origin "refs/tags/$tag"
                echo "Pushed tag $tag"
              fi
            fi
          done
